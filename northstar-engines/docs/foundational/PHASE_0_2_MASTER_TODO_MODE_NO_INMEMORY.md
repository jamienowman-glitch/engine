# Phase 0→2 Master TODO (Mode + No-InMemory) — Two Lanes

## Lane A — Contract + Storage + Durability
- MUST CHANGE: RequestContext to require mode (saas|enterprise|lab) via X-Mode; reject legacy env; remove body fallback except guarded legacy flag (engines/common/identity.py:22-151). DoD: all context builds fail without mode; X-Env absent; tests assert rejection of dev/staging/prod.
- MUST CHANGE: Event schemas/envelopes include mode/project/app/surface/run/step/schema_version/severity/storage_class; replace env with mode (engines/dataset/events/schemas.py:9-32; engines/realtime/contracts.py:74-165; emitters e.g., engines/chat/pipeline.py:55-68; engines/nexus/vector_explorer/service.py:72-104; ingest_service.py:75-201). DoD: validation rejects missing fields; emitters populate full scope.
- MUST CHANGE: Eliminate in-memory/noop defaults; startup fail-fast if durable backend absent (engines/memory/repository.py:104-111; engines/nexus/memory/service.py:16-72; engines/budget/repository.py:175-182; engines/chat/service/transport_layer.py:65-121; vector_explorer logger defaults service.py:167-175). DoD: memory/budget/nexus memory/chat bus/event logger require durable config; tests run against real isolated backends.
- MUST CHANGE: Durable replay for SSE/WS with cursor/Last-Event-ID backed by stored timeline (transport_layer.py:65-121; sse_transport.py:23-68; ws_transport.py:136-205). DoD: replay works after process restart; in-memory path removed.
- MUST CHANGE: Audit append-only with hash chaining and storage_class=audit (engines/logging/audit.py:18-53 plus sink). DoD: audit writes carry prev_hash/hash; attempts to mutate fail.

## Lane B — PII Boundary + UI/Agents/Connectors Integration
- MUST CHANGE: PII redaction before LLM/tool/embedding calls with rehydration hooks; extend logging engine or shared middleware (engines/chat/service/llm_client.py:27-50; engines/nexus/vector_explorer/service.py:107-135; ingest_service.py:168-188). DoD: raw prompts never leave after redaction; pii_flags/train_ok logged; rehydration path documented.
- MUST CHANGE: UI/clients send X-Mode/X-Tenant-Id/X-Project-Id/(surface/app/user/request) on all transports; SSE/WS enforce these; actor_id from token when present (sse_transport.py:44-58; ws_transport.py:136-160). DoD: engines reject missing mode/tenant/project; UI emits headers; actor_id override forbidden when token exists.
- MUST CHANGE: Usage/cost events carry run_id/step_id/model/tool, storage_class=cost, mode-scoped; no in-memory repo (engines/budget/routes.py:12-78; engines/budget/repository.py:175-182; vector_explorer usage emitters service.py:118-135; ingest_service.py:228-246). DoD: events persist to durable store with full scope; queries by tenant/mode/project/run pass.
- MUST CHANGE: Agents runtime align to mode contract and emit stable run_id/trace; no in-memory state adapters (northstar-agents docs/foundational/NORTHSTAR_AGENTS_RECON_REPORT.md references). DoD: agent invocations carry headers/fields; state stored durably; run_id not orphaned.
- MUST CHANGE: Connector calls include tenant/mode/project context and honor PII boundary; forbid noop/memory configs (northstar-connectors src/*). DoD: connector requests validated for headers; backend selection rejects in-memory.
