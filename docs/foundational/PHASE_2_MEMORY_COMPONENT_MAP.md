# Phase 2 Memory â€” Component Map

| Component | Entry points (routes/services) | Persistence backend(s) | Scope fields present? (tenant/env/project/surface/app/user/request/trace) | Routing used? | In-memory/noop/local fallback? | Emits logs/events? | Notes + risks |
| --- | --- | --- | --- | --- | --- | --- | --- |
| Vector explorer (scene/query) | `/vector-explorer/scene` (engines/nexus/vector_explorer/routes.py:32-61); VectorExplorerService (service.py:33-175) | Firestore corpus repo (repository.py:71-127); Vertex vector store (vector_store.py:63-226) | tenant/env only on DatasetEvents; no project/app/user/request/trace/run/step (service.py:72-104) | Selecta/runtime_config for Vertex project/endpoint/index (vector_store.py:63-226) | No event logger by default (no-op); corpus repo uses Firestore only (no in-memory by default) | DatasetEvents emitted but dropped by default logger (service.py:167-175) | Vector store requires Vertex config; query_by_datapoint_id not implemented; no PII redaction on query_text. |
| Vector explorer ingest (Haze) | `/vector-explorer/ingest` (ingest_routes.py:26-73); VectorIngestService (ingest_service.py:32-247) | Firestore corpus repo; Vertex vector store; GCS for binaries (storage/gcs_client.py:17-75) | tenant/env on DatasetEvents; missing project/app/run/step/request/trace/severity (ingest_service.py:75-201) | Selecta/runtime_config for Vertex store; GCS bucket from runtime_config | Memory logger default no-op; Firestore fallback to in-memory not used; GCS temp fallback for test buckets | DatasetEvents + audit emit; Budget usage events (ingest_service.py:75-201,160-165,228-246) | PII redaction absent for text_content/query_text; audit lacks hash chain; cost events lack run/step. |
| Scene builder (vector explorer) | build_scene (scene_builder.py:12-48); used by VectorExplorerService | In-memory transform only | N/A | N/A | N/A | No | Pure mapping; no persistence/logging. |
| Memory service (blackboard/session) | `/memory/session/messages`, `/memory/blackboards/{key}` (engines/memory/routes.py:12-65); MemoryService (service.py:10-53) | InMemoryMemoryRepository default; FirestoreMemoryRepository optional (repository.py:20-111,104-111) | tenant/env/user on session paths; no project/app/run/trace on stored records | Env var MEMORY_BACKEND only | Yes (defaults to in-memory) | No structured events/logs | User_id required; silent in-memory fallback; no retention or audit. |
| Nexus session memory | `/nexus/memory/session/{id}` (engines/nexus/memory/routes.py:13-59); SessionMemoryService (service.py:16-72) | In-memory global dict `_GLOBAL_MEMORY` only | tenant/env via key; user_id optional; no project/app/run/trace | None | Yes (in-memory only) | EventLogEntry -> DatasetEvent via default_event_logger; no sink configured | Not durable; no routing; logging sink likely no-op; rate-limit/kill-switch enforced. |
| Chat pipeline persistence | engines/chat/pipeline.py:45-69 | Nexus backend (firestore/bigquery enforced in get_backend) | tenant/env/request_id; no project/app/user in logged event when context absent | runtime_config NEXUS_BACKEND env | Memory/noop rejected; firestore default | DatasetEvent logged | Thread messages stored in bus (memory/redis), not durable. |
| Realtime transports | SSE `/sse/chat/{thread_id}` (sse_transport.py:23-68); WS `/ws/chat/{thread_id}` (ws_transport.py:136-205); bus (transport_layer.py:11-121) | In-memory bus or Redis (CHAT_BUS_BACKEND) | RequestContext tenant/env/user/request_id; no project/app/run/step in StreamEvent routing | Env var CHAT_BUS_BACKEND redis/memory | Memory default rejected but still bus replay in-memory | StreamEvent constructed from Message | No durable replay; resume cursor reads from bus memory only. |
| Raw storage | RawStorageRepository S3 impl (engines/nexus/raw_storage/repository.py:35-123) | S3 bucket (RAW_BUCKET); metadata persistence noop | tenant/env in key path; no project/app/user/run/trace | runtime_config RAW_BUCKET | InMemoryRawStorageRepository for tests | No events | Fail-fast on missing RAW_BUCKET; metadata not stored. |
| Privacy/PII filter | Logging engine (engines/logging/events/engine.py:17-46); PII regex (guardrails/pii_text/engine.py:1-43) | Nexus backend (firestore/bigquery) for DatasetEvents | tenant/env/surface/agentId/traceId/requestId set in logging engine; missing project/app/run/step/severity | Nexus backend selection (runtime_config) | No memory fallback allowed; backend enforced | Yes (DatasetEvent) | Not applied to vector ingest/query or chat llm_client inputs. |
| Budget usage (cost) | `/budget/usage` routes (engines/budget/routes.py:12-78); BudgetService/repo (repository.py:36-182) | InMemory default; Firestore optional | tenant/env; no project/app/run/step | Env var BUDGET_BACKEND | Yes (in-memory default) | UsageEvent persisted | Run/step/model context missing; in-memory default risky. |
