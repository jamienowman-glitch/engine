============================= test session starts ==============================
platform darwin -- Python 3.12.8, pytest-9.0.1, pluggy-1.6.0 -- /usr/local/bin/python3
cachedir: .pytest_cache
rootdir: /Users/jaynowman/dev/northstar-engines
configfile: pytest.ini
plugins: anyio-4.11.0, langsmith-0.4.59
collecting ... collected 1 item

tests/test_budget_enforcement.py::test_gate_chain_enforces_daily_cap FAILED [100%]

=================================== FAILURES ===================================
______________________ test_gate_chain_enforces_daily_cap ______________________

    def test_gate_chain_enforces_daily_cap():
        # 1. Setup Mock Budget Service
        mock_budget = MagicMock()
        # Scenario: Tool has spent $4.00 already
        mock_budget.get_tool_spend.return_value = Decimal("4.00")
    
        # 2. Setup GateChain
        # Mock other services to avoid noise
        chain = GateChain(
            kill_switch_service=MagicMock(),
            firearms_service=MagicMock(),
            strategy_lock_service=MagicMock(),
            budget_service=mock_budget,
            kpi_service=MagicMock(),
            temperature_service=MagicMock(),
            budget_policy_repo=MagicMock(),
            audit_logger=MagicMock()
        )
    
        # Mock allow checks on other services
        chain.kill_switch.ensure_action_allowed.return_value = None
        chain.firearms.check_access.return_value = MagicMock(allowed=True)
        chain.strategy_lock.resolve.return_value = MagicMock(allowed=True) # Assuming resolve usage if updated, but let's check what run() calls.
        # Actually run() calls resolve_strategy_lock imported from module, which we can't easily mock here without patching.
        # BUT, if we use `with patch` it works.
        # OR we rely on the fact that `run` calls `self.strategy_lock` methods?
        # Wait, previous `run` implementation used `resolve_strategy_lock` global function.
        # Let's mock `resolve_strategy_lock` via patch.
    
>       ctx = RequestContext(tenant_id="t_test", env="dev", mode="test", user_id="u1")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_budget_enforcement.py:37: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
<string>:22: in __init__
    ???
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = RequestContext(tenant_id='t_test', env='dev', project_id='p_internal', surface_id=None, app_id=None, user_id='u1', mem...5fab4b924d5992a5cdc', trace_id=None, run_id=None, step_id=None, strategy_lock_id=None, three_wise_id=None, mode='test')

    def __post_init__(self) -> None:
        if not self.tenant_id:
            raise ValueError("tenant_id is required")
        if not VALID_TENANT_PATTERN.match(self.tenant_id):
            raise ValueError(
                f"tenant_id must match pattern ^t_[a-z0-9_-]+$, got: {self.tenant_id}"
            )
        if not self.project_id:
            raise ValueError("project_id is required")
        if not self.request_id:
            raise ValueError("request_id is required")
    
        env_value = (self.env or _default_env()).lower()
        self.env = env_value
    
        mode_value = self.mode
        mode_provided = mode_value is not None
        if mode_provided:
            self._mode_provided = True
            if not mode_value:
                raise ValueError("mode is required")
        if not mode_value:
            mode_value = env_value
        if not mode_value:
            raise ValueError("mode is required")
        normalized_mode = mode_value.lower()
        if self._mode_provided and normalized_mode not in VALID_MODES:
>           raise ValueError(f"mode must be one of {VALID_MODES}, got: {normalized_mode}")
E           ValueError: mode must be one of frozenset({'lab', 'enterprise', 'saas'}), got: test

engines/common/identity.py:91: ValueError
=============================== warnings summary ===============================
engines/realtime/contracts.py:102
  /Users/jaynowman/dev/northstar-engines/engines/realtime/contracts.py:102: PydanticDeprecatedSince20: Pydantic V1 style `@root_validator` validators are deprecated. You should migrate to Pydantic V2 style `@model_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @root_validator(skip_on_failure=True)

../../../../Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
  /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

../../../../Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298
  /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:298: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.11/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(

../../../../Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/_pytest/config/__init__.py:1397
  /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/_pytest/config/__init__.py:1397: PytestConfigWarning: Unknown config option: import_mode
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

engines/budget/models.py:46
  /Users/jaynowman/dev/northstar-engines/engines/budget/models.py:46: PydanticDeprecatedSince20: Pydantic V1 style `@root_validator` validators are deprecated. You should migrate to Pydantic V2 style `@model_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @root_validator(skip_on_failure=True)

engines/budget/models.py:64
  /Users/jaynowman/dev/northstar-engines/engines/budget/models.py:64: PydanticDeprecatedSince20: Pydantic V1 style `@root_validator` validators are deprecated. You should migrate to Pydantic V2 style `@model_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @root_validator(pre=True)

engines/dataset/events/schemas.py:56
  /Users/jaynowman/dev/northstar-engines/engines/dataset/events/schemas.py:56: PydanticDeprecatedSince20: Pydantic V1 style `@root_validator` validators are deprecated. You should migrate to Pydantic V2 style `@model_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @root_validator(skip_on_failure=True)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_budget_enforcement.py::test_gate_chain_enforces_daily_cap
======================== 1 failed, 7 warnings in 0.20s =========================
