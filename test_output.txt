============================= test session starts ==============================
platform darwin -- Python 3.12.8, pytest-9.0.1, pluggy-1.6.0 -- /usr/local/bin/python3
cachedir: .pytest_cache
rootdir: /Users/jaynowman/dev/northstar-engines
configfile: pytest.ini
plugins: anyio-4.11.0, langsmith-0.4.59
collecting ... collected 1 item

engines/audio_semantic_timeline/tests/test_audio_semantic_caching.py::test_audio_semantic_caching FAILED [100%]

=================================== FAILURES ===================================
_________________________ test_audio_semantic_caching __________________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110267230>

    def test_audio_semantic_caching(monkeypatch):
        media_service = MediaService(repo=InMemoryMediaRepository(), storage=DummyStorage())
        set_media_service(media_service)
        backend_calls = {"count": 0}
    
        class DummyBackend:
            backend_version = "audio_semantic_stub_v1"
    
            def analyze(self, audio_path, include_beats, include_speech_music, min_silence_ms, loudness_window_ms):
                backend_calls["count"] += 1
                from engines.audio_semantic_timeline.models import AudioSemanticTimelineSummary, AudioEvent
    
                return AudioSemanticTimelineSummary(
                    asset_id="",
                    duration_ms=10000,
                    events=[AudioEvent(kind="speech", start_ms=0, end_ms=1000)],
                    beats=[],
                    meta={},
                )
    
        set_audio_semantic_service(AudioSemanticService(backend=DummyBackend()))
    
        audio_path = Path(tempfile.mkdtemp()) / "audio.wav"
        audio_path.write_bytes(b"dummy")
        asset = media_service.register_remote(
            MediaUploadRequest(tenant_id="t_test", env="dev", user_id="u1", kind="audio", source_uri=str(audio_path))
        )
    
        app = FastAPI()
        app.include_router(semantic_router)
        client = TestClient(app)
    
        payload = {"tenant_id": "t_test", "env": "dev", "user_id": "u1", "asset_id": asset.id}
        resp1 = client.post("/audio/semantic-timeline/analyze", json=payload)
>       assert resp1.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

engines/audio_semantic_timeline/tests/test_audio_semantic_caching.py:67: AssertionError
=============================== warnings summary ===============================
../../../../Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/_pytest/config/__init__.py:1397
  /Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/_pytest/config/__init__.py:1397: PytestConfigWarning: Unknown config option: import_mode
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

engines/media_v2/models.py:102
  /Users/jaynowman/dev/northstar-engines/engines/media_v2/models.py:102: PydanticDeprecatedSince20: Pydantic V1 style `@root_validator` validators are deprecated. You should migrate to Pydantic V2 style `@model_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @root_validator(skip_on_failure=True)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED engines/audio_semantic_timeline/tests/test_audio_semantic_caching.py::test_audio_semantic_caching
======================== 1 failed, 2 warnings in 1.14s =========================
